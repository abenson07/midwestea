{
  "master": {
    "tasks": [
      {
        "id": "1",
        "title": "Set up Resend account and configure SMTP for Supabase Auth",
        "description": "Configure Resend as the SMTP provider for Supabase Auth to handle OTP emails reliably",
        "details": "1. Create Resend account at resend.com\n2. Verify sending domain (midwestea.com) in Resend dashboard\n3. Generate Resend API key from dashboard\n4. Navigate to Supabase Project Settings > Authentication > SMTP\n5. Enable 'Custom SMTP' with settings:\n   - SMTP Host: smtp.resend.com\n   - SMTP Port: 465 (SSL/TLS)\n   - SMTP Username: resend\n   - SMTP Password: [Resend API Key]\n   - Sender Email: noreply@midwestea.com\n   - Sender Name: MidwestEA Support\n6. Save configuration and test OTP delivery\n7. Store RESEND_API_KEY in environment variables\n8. Document configuration steps for future reference",
        "testStrategy": "Test OTP email delivery by triggering password reset or sign-up flow. Verify emails are delivered within 5 seconds and appear in Resend dashboard logs. Test with multiple email providers (Gmail, Outlook, etc.) to ensure deliverability.",
        "priority": "high",
        "dependencies": [],
        "status": "done",
        "subtasks": [
          {
            "id": 1,
            "title": "Create Resend account and verify domain",
            "description": "Set up Resend account and verify the midwestea.com domain for email sending",
            "dependencies": [],
            "details": "1. Navigate to resend.com and create a new account\n2. Complete account verification process\n3. Access the Resend dashboard\n4. Navigate to the Domains section\n5. Add midwestea.com as a sending domain\n6. Follow domain verification steps (add DNS records)\n7. Wait for domain verification to complete\n8. Confirm domain status shows as verified",
            "status": "pending",
            "testStrategy": "Verify domain appears as 'Verified' in Resend dashboard. Test DNS records are properly configured using dig or nslookup commands.",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Generate and secure Resend API key",
            "description": "Create Resend API key and store it securely in environment variables",
            "dependencies": [
              1
            ],
            "details": "1. In Resend dashboard, navigate to API Keys section\n2. Click 'Create API Key' button\n3. Provide descriptive name (e.g., 'MidwestEA-Supabase-Auth')\n4. Select appropriate permissions for sending emails\n5. Copy the generated API key immediately\n6. Add RESEND_API_KEY to environment variables (.env files)\n7. Ensure API key is added to production environment variables\n8. Test API key validity with a simple API call",
            "status": "pending",
            "testStrategy": "Test API key by making a test API call to Resend. Verify key is properly loaded from environment variables in both development and production environments.",
            "parentId": "undefined"
          },
          {
            "id": 3,
            "title": "Configure Supabase SMTP settings",
            "description": "Set up custom SMTP configuration in Supabase Auth using Resend credentials",
            "dependencies": [
              2
            ],
            "details": "1. Log into Supabase project dashboard\n2. Navigate to Project Settings > Authentication\n3. Scroll to SMTP Settings section\n4. Enable 'Custom SMTP' option\n5. Configure SMTP settings:\n   - SMTP Host: smtp.resend.com\n   - SMTP Port: 465\n   - SMTP Username: resend\n   - SMTP Password: [Resend API Key from environment]\n   - Sender Email: noreply@midwestea.com\n   - Sender Name: MidwestEA Support\n6. Save configuration changes",
            "status": "pending",
            "testStrategy": "Verify SMTP settings are saved correctly in Supabase dashboard. Check that all fields display the correct values after saving.",
            "parentId": "undefined"
          },
          {
            "id": 4,
            "title": "Test OTP email delivery functionality",
            "description": "Verify that OTP emails are being sent successfully through the configured Resend SMTP",
            "dependencies": [
              3
            ],
            "details": "1. Trigger OTP email by initiating password reset flow\n2. Test with multiple email addresses (Gmail, Outlook, Yahoo)\n3. Verify emails are delivered within 5 seconds\n4. Check email content and formatting\n5. Confirm sender appears as 'MidwestEA Support <noreply@midwestea.com>'\n6. Monitor Resend dashboard for delivery logs\n7. Test OTP functionality by completing authentication flow\n8. Verify emails don't land in spam folders",
            "status": "pending",
            "testStrategy": "Test OTP delivery with at least 3 different email providers. Measure delivery time and verify 100% delivery rate. Check Resend dashboard logs for successful sends and any bounce/complaint notifications.",
            "parentId": "undefined"
          },
          {
            "id": 5,
            "title": "Document configuration and create troubleshooting guide",
            "description": "Create comprehensive documentation for the Resend SMTP configuration and troubleshooting steps",
            "dependencies": [
              4
            ],
            "details": "1. Create documentation file (README-resend-setup.md)\n2. Document complete setup process with screenshots\n3. Include environment variable requirements\n4. Document SMTP configuration values\n5. Create troubleshooting section covering:\n   - Common delivery issues\n   - DNS verification problems\n   - API key authentication errors\n   - Rate limiting considerations\n6. Include monitoring and maintenance procedures\n7. Document rollback procedures if needed\n8. Add contact information for Resend support",
            "status": "pending",
            "testStrategy": "Review documentation with team members. Test setup process using documentation on a fresh environment. Verify all troubleshooting steps are accurate and helpful.",
            "parentId": "undefined"
          }
        ],
        "updatedAt": "2026-01-03T23:13:59.124Z"
      },
      {
        "id": "2",
        "title": "Install Resend SDK and create email utility functions",
        "description": "Set up Resend SDK integration and create core email utility functions for the application",
        "details": "1. Install Resend SDK: npm install resend@latest\n2. Create apps/webapp/lib/email.ts with:\n   - Initialize Resend client with API key from environment\n   - sendEmail() base function with error handling and retry logic (max 3 retries with exponential backoff)\n   - Email template rendering helpers\n   - Logging utilities for email attempts\n3. Add TypeScript types for email templates and data\n4. Implement rate limiting awareness (Resend free tier: 100 emails/day, paid: higher limits)\n5. Add email validation utilities\n6. Create error classes for different email failure types\n7. Add comprehensive JSDoc documentation",
        "testStrategy": "Unit tests for email utility functions with mocked Resend client. Test retry logic with simulated failures. Verify proper error handling and logging. Test email validation functions with various input formats.",
        "priority": "high",
        "dependencies": [
          "1"
        ],
        "status": "done",
        "subtasks": [
          {
            "id": 1,
            "title": "Install Resend SDK package",
            "description": "Install the latest version of the Resend SDK package as a dependency for the webapp",
            "dependencies": [],
            "details": "Run 'npm install resend@latest' in the apps/webapp directory to add the Resend SDK to the project dependencies. Verify the installation by checking package.json and node_modules.",
            "status": "pending",
            "testStrategy": "Verify package installation by checking package.json contains resend dependency and running npm list resend to confirm version",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Create email utility file structure and Resend client initialization",
            "description": "Set up the basic email utility file with Resend client initialization and environment configuration",
            "dependencies": [
              1
            ],
            "details": "Create apps/webapp/lib/email.ts file with Resend client initialization using API key from environment variables. Set up proper error handling for missing API key and invalid configuration. Include proper TypeScript imports and basic file structure.",
            "status": "pending",
            "testStrategy": "Unit test client initialization with valid and invalid API keys. Mock environment variables to test configuration scenarios.",
            "parentId": "undefined"
          },
          {
            "id": 3,
            "title": "Implement core sendEmail function with retry logic",
            "description": "Create the main sendEmail function with comprehensive error handling and exponential backoff retry mechanism",
            "dependencies": [
              2
            ],
            "details": "Implement sendEmail() function with retry logic (max 3 retries with exponential backoff starting at 1 second). Include comprehensive error handling for different failure types, timeout handling, and proper logging of retry attempts. Add rate limiting awareness for Resend API limits.",
            "status": "pending",
            "testStrategy": "Unit tests with mocked Resend client to simulate failures and verify retry logic. Test exponential backoff timing and maximum retry limits. Verify proper error propagation.",
            "parentId": "undefined"
          },
          {
            "id": 4,
            "title": "Create TypeScript types and email validation utilities",
            "description": "Define comprehensive TypeScript interfaces for email templates and implement email validation functions",
            "dependencies": [
              2
            ],
            "details": "Create TypeScript interfaces for email template data, email configuration options, and response types. Implement email validation utilities including format validation, domain validation, and sanitization functions. Add types for different email template categories and their required data fields.",
            "status": "pending",
            "testStrategy": "Unit tests for email validation with various valid and invalid email formats. Test type safety with TypeScript compiler. Verify validation functions handle edge cases and malformed inputs.",
            "parentId": "undefined"
          },
          {
            "id": 5,
            "title": "Implement email template helpers and error classes with documentation",
            "description": "Create email template rendering helpers, custom error classes, and comprehensive JSDoc documentation",
            "dependencies": [
              3,
              4
            ],
            "details": "Implement email template rendering helpers for dynamic content generation. Create custom error classes for different email failure types (NetworkError, ValidationError, RateLimitError, etc.). Add comprehensive JSDoc documentation for all functions, types, and classes. Include logging utilities for email attempts and outcomes.",
            "status": "pending",
            "testStrategy": "Unit tests for template rendering with various data inputs. Test custom error classes inheritance and error message formatting. Verify JSDoc generates proper documentation. Test logging utilities capture correct information.",
            "parentId": "undefined"
          }
        ],
        "updatedAt": "2026-01-03T23:21:02.552Z"
      },
      {
        "id": "3",
        "title": "Create HTML email templates for enrollment confirmations",
        "description": "Design and implement responsive HTML email templates for course and program enrollment confirmations",
        "details": "1. Create apps/webapp/lib/email-templates/ directory\n2. Implement course enrollment template:\n   - Subject: 'Welcome to [Course Name] - Enrollment Confirmed'\n   - Responsive HTML design with MidwestEA branding\n   - Include course details, payment confirmation, 'link coming shortly' message\n   - Template variables: studentName, courseName, courseCode, amount, invoiceNumber, paymentDate\n3. Implement program enrollment template:\n   - Subject: 'Welcome to [Program Name] - Enrollment Confirmed'\n   - Include class start date, payment confirmation, outstanding invoices table\n   - Template variables: studentName, programName, courseCode, startDate, paidAmount, outstandingInvoices[]\n4. Use modern HTML email best practices:\n   - Table-based layout for email client compatibility\n   - Inline CSS for styling\n   - Alt text for images\n   - Fallback fonts\n5. Create template rendering functions with proper escaping\n6. Add email preview functionality for development",
        "testStrategy": "Test templates across major email clients (Gmail, Outlook, Apple Mail, Yahoo). Use email testing tools like Litmus or Email on Acid. Verify responsive design on mobile devices. Test with sample data to ensure proper variable substitution and formatting.",
        "priority": "medium",
        "dependencies": [
          "2"
        ],
        "status": "done",
        "subtasks": [
          {
            "id": 1,
            "title": "Create email templates directory structure and base template files",
            "description": "Set up the directory structure and create base HTML template files for course and program enrollment confirmations",
            "dependencies": [],
            "details": "Create apps/webapp/lib/email-templates/ directory. Create course-enrollment.html and program-enrollment.html base template files with proper HTML5 structure, meta tags for email clients, and placeholder content sections for dynamic data insertion.",
            "status": "done",
            "testStrategy": "Verify directory structure is created correctly and template files contain valid HTML markup that passes W3C validation",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Implement course enrollment HTML template with MidwestEA branding",
            "description": "Design and code the responsive HTML template for course enrollment confirmations with proper branding and styling",
            "dependencies": [
              1
            ],
            "details": "Create table-based layout for email client compatibility with inline CSS styling. Include MidwestEA logo, course details section, payment confirmation area, and 'link coming shortly' message. Implement template variables: studentName, courseName, courseCode, amount, invoiceNumber, paymentDate. Use fallback fonts and alt text for images.",
            "status": "done",
            "testStrategy": "Test template rendering across Gmail, Outlook, Apple Mail, and Yahoo. Verify responsive design on mobile devices and proper variable substitution with sample data",
            "parentId": "undefined"
          },
          {
            "id": 3,
            "title": "Implement program enrollment HTML template with outstanding invoices table",
            "description": "Design and code the responsive HTML template for program enrollment confirmations including outstanding invoices display",
            "dependencies": [
              1
            ],
            "details": "Create table-based layout with MidwestEA branding, program details section, class start date display, payment confirmation, and outstanding invoices table. Implement template variables: studentName, programName, courseCode, startDate, paidAmount, outstandingInvoices[]. Include proper table formatting for invoice data with columns for invoice number, amount, and due date.",
            "status": "done",
            "testStrategy": "Test template with various invoice scenarios including no outstanding invoices, single invoice, and multiple invoices. Verify table formatting across different email clients",
            "parentId": "undefined"
          },
          {
            "id": 4,
            "title": "Create template rendering functions with variable substitution and escaping",
            "description": "Implement JavaScript/TypeScript functions to render email templates with proper data binding and security measures",
            "dependencies": [
              2,
              3
            ],
            "details": "Create renderCourseEnrollmentTemplate() and renderProgramEnrollmentTemplate() functions in apps/webapp/lib/email-templates/index.ts. Implement proper HTML escaping for all template variables to prevent XSS attacks. Add helper functions for formatting currency, dates, and handling missing data gracefully. Include TypeScript type definitions for template data structures.",
            "status": "done",
            "testStrategy": "Unit tests with various data inputs including edge cases like special characters, null values, and malformed data. Verify HTML escaping prevents script injection",
            "parentId": "undefined"
          },
          {
            "id": 5,
            "title": "Add email preview functionality for development and testing",
            "description": "Implement development tools to preview and test email templates before sending",
            "dependencies": [
              4
            ],
            "details": "Create email preview route/endpoint that renders templates with sample data for development testing. Add functionality to preview templates in browser with mobile/desktop views. Include tools to test with different sample datasets and export rendered HTML for external email testing tools like Litmus or Email on Acid.",
            "status": "done",
            "testStrategy": "Test preview functionality with various sample data sets. Verify rendered output matches expected template design and all variables are properly substituted",
            "parentId": "undefined"
          }
        ],
        "updatedAt": "2026-01-03T23:25:10.708Z"
      },
      {
        "id": "4",
        "title": "Implement database queries for outstanding invoices",
        "description": "Create database query functions to retrieve and calculate outstanding invoice data for program enrollment emails",
        "details": "1. Add to apps/webapp/lib/enrollments.ts:\n   - getOutstandingInvoices(enrollmentId: string) function\n   - Query: SELECT invoice_number, transaction_type, quantity, amount_due, due_date, (quantity * amount_due) as total_amount FROM transactions WHERE enrollment_id = ? AND transaction_status = 'pending' ORDER BY due_date ASC\n2. Add helper functions:\n   - calculateTotalOutstanding(transactions: Transaction[]): number\n   - formatCurrency(amountInCents: number): string\n   - formatDueDate(date: Date): string\n3. Add TypeScript interfaces:\n   - OutstandingInvoice interface\n   - InvoiceCalculation interface\n4. Implement proper error handling for database queries\n5. Add query result caching if needed for performance\n6. Use Supabase client with proper connection pooling\n7. Add comprehensive logging for database operations",
        "testStrategy": "Unit tests with mock database responses. Integration tests with real database using test data. Verify calculations are accurate (quantity * amount_due). Test edge cases: no outstanding invoices, multiple invoices, large amounts. Performance testing with large datasets.",
        "priority": "medium",
        "dependencies": [],
        "status": "done",
        "subtasks": [
          {
            "id": 1,
            "title": "Create TypeScript interfaces for outstanding invoices",
            "description": "Define TypeScript interfaces for outstanding invoice data structures and calculations",
            "dependencies": [],
            "details": "Create OutstandingInvoice interface with fields: invoice_number, transaction_type, quantity, amount_due, due_date, total_amount. Create InvoiceCalculation interface for calculation results. Add these interfaces to apps/webapp/lib/enrollments.ts with proper type definitions and JSDoc comments.",
            "status": "done",
            "testStrategy": "Unit tests to verify interface structure and type checking with sample data",
            "parentId": "undefined"
          },
          {
            "id": 2,
            "title": "Implement getOutstandingInvoices database query function",
            "description": "Create the main database query function to retrieve outstanding invoices for a specific enrollment",
            "dependencies": [
              1
            ],
            "details": "Add getOutstandingInvoices(enrollmentId: string) function to apps/webapp/lib/enrollments.ts. Implement SQL query: SELECT invoice_number, transaction_type, quantity, amount_due, due_date, (quantity * amount_due) as total_amount FROM transactions WHERE enrollment_id = ? AND transaction_status = 'pending' ORDER BY due_date ASC. Use Supabase client with proper connection pooling and error handling.",
            "status": "done",
            "testStrategy": "Unit tests with mock database responses and integration tests with test database data",
            "parentId": "undefined"
          },
          {
            "id": 3,
            "title": "Implement helper functions for calculations and formatting",
            "description": "Create utility functions for calculating totals and formatting currency and dates",
            "dependencies": [
              1
            ],
            "details": "Add calculateTotalOutstanding(transactions: Transaction[]): number function to sum all outstanding amounts. Implement formatCurrency(amountInCents: number): string to format monetary values with proper currency symbols. Add formatDueDate(date: Date): string for consistent date formatting. Include proper input validation and error handling for edge cases.",
            "status": "done",
            "testStrategy": "Unit tests with various input scenarios including edge cases like zero amounts, large numbers, and invalid dates",
            "parentId": "undefined"
          },
          {
            "id": 4,
            "title": "Add comprehensive error handling and logging",
            "description": "Implement robust error handling for database operations and add comprehensive logging",
            "dependencies": [
              2,
              3
            ],
            "details": "Add try-catch blocks around all database operations with specific error types. Implement comprehensive logging for database queries, results, and errors using structured logging format. Add proper error messages and status codes. Include connection timeout handling and retry logic for transient failures.",
            "status": "done",
            "testStrategy": "Test error scenarios including database connection failures, invalid queries, and network timeouts",
            "parentId": "undefined"
          },
          {
            "id": 5,
            "title": "Implement query result caching and performance optimization",
            "description": "Add caching mechanism for outstanding invoice queries and optimize performance",
            "dependencies": [
              2,
              4
            ],
            "details": "Implement query result caching using appropriate caching strategy (in-memory or Redis-based). Add cache invalidation logic for when invoice data changes. Optimize database queries with proper indexing recommendations. Add performance monitoring and query execution time logging. Include cache hit/miss metrics.",
            "status": "done",
            "testStrategy": "Performance testing with large datasets, cache hit/miss ratio verification, and load testing to ensure caching improves response times",
            "parentId": "undefined"
          }
        ],
        "updatedAt": "2026-01-03T23:38:51.599Z"
      },
      {
        "id": "5",
        "title": "Research and implement email account creation for new students",
        "description": "Research email service provider APIs and implement automated email account creation for new students",
        "details": "1. Research email account creation options:\n   - Option A: Resend email forwarding/aliases (if supported)\n   - Option B: Google Workspace Admin SDK integration\n   - Option C: Microsoft 365 Graph API integration\n   - Option D: Custom email server with API (Postfix/Dovecot)\n2. Based on research, implement chosen solution:\n   - Install required SDK (e.g., googleapis@latest for Google Workspace)\n   - Create createStudentEmailAccount(student) function\n   - Email format: firstname.lastname@midwestea.com or student_id@midwestea.com\n   - Handle duplicate email addresses with numbering\n3. Add to apps/webapp/lib/email.ts:\n   - Email account creation with proper error handling\n   - Logging for audit purposes\n   - Non-blocking implementation (failures don't prevent student creation)\n4. Store additional environment variables as needed:\n   - GOOGLE_WORKSPACE_ADMIN_EMAIL, GOOGLE_SERVICE_ACCOUNT_KEY (if Google)\n   - MICROSOFT_TENANT_ID, MICROSOFT_CLIENT_ID, MICROSOFT_CLIENT_SECRET (if Microsoft)\n5. Add comprehensive error handling and retry logic",
        "testStrategy": "Test email account creation with various student name formats. Verify accounts can receive emails. Test error scenarios: duplicate emails, API failures, network issues. Ensure failures don't block student registration. Monitor API rate limits and costs.",
        "priority": "medium",
        "dependencies": [
          "2"
        ],
        "status": "deferred",
        "subtasks": [],
        "updatedAt": "2026-01-03T23:40:15.448Z"
      },
      {
        "id": "6",
        "title": "Integrate email account creation into student registration workflow",
        "description": "Modify the findOrCreateStudent function to automatically create email accounts for new students",
        "details": "1. Modify apps/webapp/lib/enrollments.ts findOrCreateStudent() function:\n   - Add email account creation after successful student creation\n   - Call createStudentEmailAccount(student) asynchronously\n   - Implement try-catch to prevent email failures from blocking student creation\n2. Add logging for email account creation attempts:\n   - Success: log student ID, email created, timestamp\n   - Failure: log student ID, error message, timestamp\n3. Consider adding email account status to student record:\n   - Add email_account_status field ('pending', 'created', 'failed')\n   - Update status based on creation results\n4. Implement background retry mechanism for failed email account creations:\n   - Queue failed attempts for retry\n   - Exponential backoff strategy\n   - Maximum retry attempts (3-5)\n5. Add admin notification for persistent failures\n6. Ensure backward compatibility with existing student records",
        "testStrategy": "Integration tests with complete student registration flow. Test scenarios: successful email creation, email creation failure, network timeouts. Verify student registration completes even when email creation fails. Test retry mechanism with simulated failures. Monitor logs for proper error tracking.",
        "priority": "medium",
        "dependencies": [
          "4",
          "5"
        ],
        "status": "deferred",
        "subtasks": [],
        "updatedAt": "2026-01-03T23:40:15.599Z"
      },
      {
        "id": "7",
        "title": "Implement course enrollment confirmation email functionality",
        "description": "Create function to send course enrollment confirmation emails with proper template rendering and error handling",
        "details": "1. Add to apps/webapp/lib/email.ts:\n   - sendCourseEnrollmentEmail(student, enrollment, class, transaction) function\n   - Use course enrollment HTML template\n   - Template data mapping:\n     * studentName: student.first_name + ' ' + student.last_name\n     * courseName: class.class_name\n     * courseCode: class.course_code\n     * amount: formatCurrency(transaction.amount_paid)\n     * invoiceNumber: transaction.invoice_number\n     * paymentDate: formatDate(transaction.payment_date)\n2. Implement proper error handling:\n   - Catch and log email sending errors\n   - Don't throw errors that would break webhook processing\n   - Retry logic with exponential backoff (max 3 attempts)\n3. Add email delivery logging:\n   - Log to database or external service\n   - Include: timestamp, recipient, email type, status, error details\n4. Add email validation before sending\n5. Use Resend API with proper headers and metadata\n6. Implement email preview functionality for development/testing",
        "testStrategy": "Unit tests with mocked Resend client and sample data. Integration tests with real Resend API in staging. Test error scenarios: invalid email addresses, API failures, network timeouts. Verify retry logic works correctly. Test email content rendering with various course data.",
        "priority": "high",
        "dependencies": [
          "3",
          "4"
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": "8",
        "title": "Implement program enrollment confirmation email functionality",
        "description": "Create function to send program enrollment confirmation emails including outstanding invoices calculation and display",
        "details": "1. Add to apps/webapp/lib/email.ts:\n   - sendProgramEnrollmentEmail(student, enrollment, class, paidTransaction) function\n   - Query outstanding invoices using getOutstandingInvoices(enrollment.id)\n   - Template data mapping:\n     * studentName: student.first_name + ' ' + student.last_name\n     * programName: class.class_name\n     * courseCode: class.course_code\n     * startDate: formatDate(class.class_start_date)\n     * paidAmount: formatCurrency(paidTransaction.amount_paid)\n     * invoiceNumber: paidTransaction.invoice_number\n     * paymentDate: formatDate(paidTransaction.payment_date)\n     * outstandingInvoices: formatted invoice array with calculations\n     * totalOutstanding: sum of all outstanding amounts\n2. Implement invoice formatting:\n   - Map transaction_type to readable descriptions\n   - Calculate individual amounts: quantity * amount_due\n   - Format due dates as readable strings\n   - Calculate total outstanding amount\n3. Add comprehensive error handling and logging\n4. Ensure accurate financial calculations with proper rounding\n5. Add data validation for all financial amounts",
        "testStrategy": "Unit tests with various outstanding invoice scenarios: no invoices, single invoice, multiple invoices. Verify calculations are accurate and properly formatted. Test with edge cases: zero amounts, large amounts, past due dates. Integration tests with real database data. Verify email content matches expected format.",
        "priority": "high",
        "dependencies": [
          "3",
          "4"
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": "9",
        "title": "Integrate enrollment confirmation emails into Stripe webhook handler",
        "description": "Modify the Stripe webhook handler to trigger appropriate enrollment confirmation emails based on class type",
        "details": "1. Modify apps/webapp/app/api/webhooks/stripe/route.ts:\n   - Add email sending after successful enrollment and transaction creation\n   - In checkout.session.completed handler, after createEnrollmentAndTransactions()\n2. Implement class type detection:\n   - Use existing getClassType() function to determine 'course' vs 'program'\n   - Route to appropriate email function based on type\n3. Add email sending logic:\n   - For courses: call sendCourseEnrollmentEmail()\n   - For programs: call sendProgramEnrollmentEmail()\n   - Wrap in try-catch to prevent email failures from breaking webhook\n4. Implement async email sending:\n   - Don't block webhook response waiting for email\n   - Use Promise.resolve() or background job queue if needed\n5. Add comprehensive logging:\n   - Log email sending attempts and results\n   - Include enrollment ID, student ID, email type in logs\n6. Ensure webhook responds within Stripe's timeout limits (10 seconds)\n7. Add webhook event deduplication to prevent duplicate emails",
        "testStrategy": "Integration tests with Stripe webhook events in test mode. Test both course and program enrollment flows. Verify emails are sent within 30 seconds of payment. Test webhook failure scenarios: email API down, invalid data, network issues. Ensure webhook always responds successfully to Stripe. Monitor webhook processing time.",
        "priority": "high",
        "dependencies": [
          "7",
          "8"
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": "10",
        "title": "Implement comprehensive logging and monitoring system",
        "description": "Create logging infrastructure for email operations and implement monitoring for email delivery and system health",
        "details": "1. Create email activity logging system:\n   - Add email_logs table to Supabase:\n     * id (UUID), timestamp, recipient_email, email_type, status, error_message, retry_count, enrollment_id, student_id\n   - Implement logEmailActivity() function in email.ts\n   - Log all email operations: OTP, enrollment confirmations, email account creation\n2. Add monitoring and alerting:\n   - Track email delivery rates and response times\n   - Monitor Resend API usage and rate limits\n   - Alert on high failure rates or API errors\n   - Dashboard for email metrics (optional)\n3. Implement health check endpoints:\n   - /api/health/email - test email sending capability\n   - /api/health/resend - check Resend API connectivity\n4. Add performance monitoring:\n   - Track email sending duration\n   - Monitor database query performance\n   - Log webhook processing times\n5. Create admin utilities:\n   - Retry failed emails manually\n   - View email logs and statistics\n   - Test email templates with sample data\n6. Add proper log rotation and cleanup for production\n7. Implement structured logging with proper log levels",
        "testStrategy": "Test logging with various email scenarios and verify data accuracy. Test monitoring alerts with simulated failures. Verify health check endpoints return correct status. Performance testing to ensure logging doesn't impact email sending speed. Test log cleanup and rotation mechanisms.",
        "priority": "medium",
        "dependencies": [
          "9"
        ],
        "status": "pending",
        "subtasks": []
      }
    ],
    "metadata": {
      "version": "1.0.0",
      "lastModified": "2026-01-03T23:40:15.599Z",
      "taskCount": 10,
      "completedCount": 4,
      "tags": [
        "master"
      ]
    }
  }
}